pivot_wider(
names_from = taxon,
values_from = abs_abun,
values_fill = 0
)
# Define alpha values
alpha_vals <- c(0, 0.25, 0.5, 1, 2, 4, 8)
# Function to compute Renyi profile
compute_renyi <- function(abun_vector, alpha_vals) {
renyi_values <- renyi(abun_vector, scales = alpha_vals, hill = TRUE)
data.frame(alpha = alpha_vals, renyi = renyi_values)
}
# 2. Compute Renyi diversity per sample_id
renyi_list <- phyto_matrix %>%
group_split() %>%   # split tibble into list of samples
lapply(function(df) {
mat <- df %>% select(where(is.numeric)) %>% as.matrix()
if (ncol(mat) == 0) return(NULL)
purrr::map_dfr(1:nrow(mat), function(i) {
row_vec <- mat[i, ]
meta <- df[i, c("sample_id", "site", "station",
"tow_size","tow_type","date_sampled")]
renyi_out <- compute_renyi(row_vec, alpha_vals)
cbind(renyi_out, meta)
})
})
renyi_df <- bind_rows(renyi_list)
# 3. Summarise (mean + sd) per site × tow_type × alpha
renyi_summary <- renyi_df %>%
mutate(day_label = recode(as.character(date_sampled), !!!custom_labels)) %>%
group_by(site, day_label, alpha) %>%
summarise(
mean_renyi = mean(renyi),
sd_renyi   = sd(renyi),
.groups = "drop"
)
# 4. Plot: facetted by site and tow_type
ggplot(renyi_summary %>%
mutate(site = factor(site, levels = c("AB", "WB", "SHB"))),
aes(x = alpha, y = mean_renyi,
group = day_label)) +
geom_line(aes(linetype= day_label, color = day_label), size = 1) +
geom_ribbon(aes(ymin = mean_renyi - sd_renyi,
ymax = mean_renyi + sd_renyi,
fill = day_label),
alpha = 0.2, color = NA) +
facet_wrap(~ site,
labeller = labeller(site = c("AB" = "Algoa Bay",
"SHB" = "St. Helena Bay",
"WB" = "Walker Bay"))) +
scale_x_continuous(breaks = alpha_vals) +
scale_color_manual(values =  c("gold","purple", "steelblue",
"purple", "firebrick", "purple")) +
scale_fill_manual(values =  c("gold","purple", "steelblue",
"purple", "firebrick", "purple")) +
labs(
title = "",
x = "Renyi alpha (α)",
y = "Diversity (Hill numbers)",
color = "",
linetype  = ""
) +
guides(fill = "none") +
theme_minimal() +
theme(
strip.text = element_text(size = 16, face = "bold"),
axis.text = element_text(size = 16),
axis.title = element_text(size = 16),
axis.text.x = element_text(angle = 90),
legend.text = element_text(size = 16),
legend.position = "top"
)
ggsave("C:/Resources/Campus Work/PhD/DATA/BioSCape/figures/renyi.jpg",
width = 18, height = 14, dpi = 300)
#  fine scale spatial-temporal -----------------------------------------------------
# Prepare community matrix (site-station-day as rows, taxa as columns)
comm_data <- phyto_data %>%
filter(functional_type != "Zooplankton") %>%
mutate(day_label = recode(as.character(date_sampled), !!!custom_labels2)) %>%
group_by(site, station,tow_size, tow_type,date_sampled,day_label, taxon) %>%
summarise(abundance = sum(abs_abun), .groups = "drop") %>%
pivot_wider(names_from = taxon, values_from = abundance, values_fill = 0)
# Ensure comm is a matrix with rownames
comm_mat <- comm_data %>%
unite("sample_id", site, station,tow_size,tow_type,date_sampled, day_label, remove = FALSE) %>%
column_to_rownames("sample_id") %>%
select(-site, -station,-date_sampled,-tow_type, -day_label)
metadata <- comm_data %>%
unite("sample_id", site, station,tow_size,tow_type,date_sampled, day_label, remove = FALSE) %>%
select(sample_id, site, station,tow_size,tow_type,date_sampled, day_label)
# Run NMDS
nmds <- metaMDS(comm_mat, distance = "bray", k = 2, trymax = 100)
# Extract scores and align with metadata
scores_nmds <- as.data.frame(scores(nmds, display = "sites"))
scores_nmds$sample_id <- rownames(scores_nmds)
# Merge with metadata
scores_nmds <- left_join(scores_nmds, metadata, by = "sample_id")
ggplot(scores_nmds %>%
mutate(station = as.character(station)),
aes(x = NMDS1, y = NMDS2,
color = day_label, shape = station)) +
geom_point(size = 3) +
guides(shape = "none") +
theme_minimal() +
facet_wrap(~ site,
labeller = labeller(site = c("AB" = "Algoa Bay",
"SHB" = "St. Helena Bay",
"WB" = "Walker Bay"))) +
theme(
panel.background = element_rect(fill = "white"),
panel.grid.major = element_line(color = "grey80"),
legend.position = "right",
axis.title = element_text(size = 12),
legend.key = element_rect(fill = "transparent"),
panel.grid.major.y = element_line(color = "grey75"),
legend.title = element_blank(),
strip.background = element_blank(),
strip.text = element_text(size = 12),
legend.text = element_text(size = 12),
axis.text = element_text(size = 12),
strip.placement = "outside")
adonis_results <- adonis2(comm_mat ~ site * station* day_label, data = metadata, method = "bray", permutations = 999)
print(adonis_results)
# Within-bay test
adonis_by_bay <- metadata %>%
group_split(site) %>%
map(~ adonis2(comm_mat[metadata$site == .x$site[1], ] ~ day_label * station,
data = .x, method = "bray", permutations = 999))
adonis_by_bay
dist_mat <- vegdist(comm_mat, method = "bray")
dispersion <- betadisper(dist_mat, metadata$day_label)
anova(dispersion)
# 1. Standardize site names
site_lookup <- tibble(
site_phyto = c("AB", "SHB", "WB"),
site_env   = c("AlgoaBay", "StHelenaBay", "WalkerBay")
)
# Apply to nuts_data and chla_data
nuts_clean <- nuts_data %>%
left_join(site_lookup, by = c("site" = "site_env")) %>%
rename(siteName = site_phyto)
# 2. Standardize station IDs
# phyto_data has "St1", "St2" etc, convert to numeric
metadata <- metadata %>%
mutate(station = as.numeric(str_remove(station, "St")))
# Nutrients at surface (depth = 0)
nuts_surface <- nuts_clean %>%
filter(depth == 0) %>%
group_by(site, station, date_sampled) %>%
summarise(across(starts_with("ave_"), mean, na.rm = TRUE), .groups = "drop")
# CTD at surface
ctd_surface <- ctd_raw %>%
filter(depth < 1) %>%  # take shallowest values as "surface"
group_by(site, station, date) %>%
summarise(across(c(temperature, salinity, oxygen, pH, turbidity, fluorescence),
mean, na.rm = TRUE), .groups = "drop") %>%
rename(date_sampled = date)
# Merge all env data
env_data <- nuts_surface %>%
# full_join(chla_surface, by = c("site", "station", "date_sampled")) %>%
# mutate(date_sampled = as.Date(date_sampled)) %>%
left_join(site_lookup, by = c("site" = "site_env")) %>%
select(!site) %>%
rename("site" = "site_phyto") %>%
full_join(ctd_surface, by = c("site", "station", "date_sampled")) %>%
filter(date_sampled != "2023-11-15") %>%
mutate(across(where(is.numeric), ~replace_na(., 0)))
merged <- metadata %>%
left_join(env_data, by = c("site", "station", "date_sampled"))
unique(merged$date_sampled)
dbrda_model <- capscale(comm_mat ~ ave_PO4 + ave_Si + ave_NOx + ave_NH4  +
temperature + salinity  + oxygen + pH + turbidity,
data = merged, distance = "bray")
anova(dbrda_model, by = "terms", permutations = 999)
scores_dbrda <- scores(dbrda_model, display = "sites") %>%
as.data.frame() %>%
bind_cols(merged)
# Function: run dbRDA per site
run_dbrda <- function(site_name) {
# Subset data
comm_sub <- comm_mat[merged$site == site_name, ]
meta_sub <- merged %>% filter(site == site_name)
# Run dbRDA
dbrda_sub <- capscale(comm_sub ~ ave_PO4 + ave_Si + ave_NOx + ave_NH4 +
temperature + salinity + oxygen + pH + turbidity,
data = meta_sub, distance = "bray")
# Extract variance explained (% per axis)
var_exp <- summary(dbrda_sub)$cont$importance
axis_labels <- c(
paste0("dbRDA1 (", round(var_exp[2,1] * 100, 1), "%)"),
paste0("dbRDA2 (", round(var_exp[2,2] * 100, 1), "%)")
)
# Extract adjusted R²
adjR2 <- RsquareAdj(dbrda_sub)$adj.r.squared
# Site scores
site_scores <- scores(dbrda_sub, display = "sites") %>%
as.data.frame() %>%
bind_cols(meta_sub) %>%
mutate(site = site_name,
axis1_label = axis_labels[1],
axis2_label = axis_labels[2],
adjR2 = round(adjR2, 2))  # keep 2 decimals
# Environmental fit
ef <- envfit(dbrda_sub,
meta_sub %>%
select(ave_PO4, ave_Si, ave_NOx, ave_NH4,
temperature, salinity, oxygen, pH, turbidity),
permutations = 999)
ef_scores <- as.data.frame(scores(ef, "vectors"))
ef_scores$var <- rownames(ef_scores)
ef_scores$site <- site_name
ef_scores$pval <- ef$vectors$pvals
# Keep only significant vars
ef_scores <- ef_scores %>%
filter(pval < 0.05) %>%
mutate(CAP1 = CAP1,
CAP2 = CAP2,
axis1_label = axis_labels[1],
axis2_label = axis_labels[2],
adjR2 = round(adjR2, 2))
list(sites = site_scores, env = ef_scores)
}
# Run for all sites
results <- map(unique(merged$site), run_dbrda)
# Combine
scores_all <- bind_rows(map(results, "sites"))
ef_all     <- bind_rows(map(results, "env")) %>%
mutate(var = recode(var,
"ave_Si"  = "Si",
"ave_NOx" = "NOxN",
"ave_NH4" = "NH4",
"temperature"  = "temp",
"turbidity" = "turb",
"oxygen" = "DO"))
# Plot with adjusted R² in facet titles
ggplot(scores_all %>%
mutate(site = factor(site, levels = c("AB", "WB", "SHB"))),
aes(x = CAP1, y = CAP2, color = day_label)) +
geom_point(aes(shape = day_label), size = 3) +
stat_ellipse(aes(group = day_label), linetype = 2) +
# Significant environmental arrows
geom_segment(data = ef_all %>%
mutate(site = factor(site, levels = c("AB", "WB", "SHB"))),
aes(x = 0, y = 0, xend = CAP1, yend = CAP2),
arrow = arrow(length = unit(0.25, "cm")),
inherit.aes = FALSE, color = "black") +
geom_text(data = ef_all %>%
mutate(site = factor(site, levels = c("AB", "WB", "SHB"))),
aes(x = CAP1, y = CAP2, label = var),
inherit.aes = FALSE, size = 6, vjust = -0.5) +
facet_wrap(~ site,
labeller = labeller(site = c("AB" = "Algoa Bay",
"SHB" = "St. Helena Bay",
"WB" = "Walker Bay"))) +
theme_minimal() +
labs(
title = "",
x = unique(scores_all$axis1_label),
y = unique(scores_all$axis2_label)
) +
theme(
panel.background = element_rect(fill = "white"),
panel.grid.major = element_line(color = "grey80"),
legend.position = "right",
axis.title = element_text(size = 16),
legend.key = element_rect(fill = "transparent"),
panel.grid.major.y = element_line(color = "grey75"),
legend.title = element_blank(),
strip.background = element_blank(),
strip.text = element_text(size = 16),
legend.text = element_text(size = 16),
axis.text = element_text(size = 16),
strip.placement = "outside")
ggsave("C:/Resources/Campus Work/PhD/DATA/BioSCape/figures/dbRDA_perBAy.jpg",
width = 18, height = 14, dpi = 600)
#  bubble plot --------
# Prepare community matrix (site-station-day as rows, taxa as columns)
comm_data <- phyto_data %>%
filter(functional_type != "Zooplankton") %>%
mutate(day_label = recode(as.character(date_sampled), !!!custom_labels2)) %>%
group_by(site, station, tow_size,tow_type,date_sampled,day_label, genus) %>%
summarise(cell_counts = sum(total_cells), .groups = "drop") %>%
pivot_wider(names_from = genus, values_from = cell_counts, values_fill = 0)
# Ensure comm is a matrix with rownames
comm_mat <- comm_data %>%
unite("sample_id", site, station,tow_size,tow_type,date_sampled, day_label, remove = FALSE) %>%
column_to_rownames("sample_id") %>%
select(-site, -station,-date_sampled,-tow_size,-tow_type, -day_label)
metadata <- comm_data %>%
unite("sample_id", site, station,tow_size,tow_type,date_sampled, day_label, remove = FALSE) %>%
select(sample_id, site, station,tow_size,tow_type,date_sampled, day_label)
bubble_data <- comm_mat %>%
as.data.frame() %>%
rownames_to_column("sample_id") %>%
pivot_longer(-sample_id, names_to = "taxon", values_to = "abundance") %>%
left_join(metadata, by = "sample_id")
bubble_summary <- bubble_data %>%
group_by(site, day_label, taxon) %>%
summarise(mean_abundance = mean(abundance, na.rm = TRUE),
.groups = "drop")
bubble_diff <- bubble_summary %>%
pivot_wider(names_from = day_label, values_from = mean_abundance, values_fill = 0) %>%
mutate(
ratio = (`Day 2` + 1) / (`Day 1` + 1),   # add 1 to avoid divide-by-zero
log_ratio = log2(ratio)                  # log2 fold-change (↑ or ↓)
)
top_taxa <- bubble_summary %>%
group_by(site, taxon) %>%
summarise(total_abundance = sum(mean_abundance), .groups = "drop") %>%
group_by(site) %>%
# slice_max(total_abundance, n = 50) %>%
select(site,taxon)
bubble_diff <- bubble_diff %>%
inner_join(top_taxa, by = c("site", "taxon"))
ggplot(bubble_diff %>%
mutate(site = factor(site, levels = c("AB", "WB", "SHB")),
taxon = factor (taxon)),
aes(x = site, y = fct_rev(taxon), size = abs(log_ratio), color = log_ratio)) +
geom_point() +
scale_size_continuous(range = c(1, 10)) +
scale_color_viridis_c(option = "E",name = "Day2 vs Day1 (log2 fold-change)") +
facet_wrap(~ site, scales = "free_x",
labeller = labeller(site = c("AB" = "Algoa Bay",
"SHB" = "St. Helena Bay",
"WB" = "Walker Bay"))) +
labs(title = "",
x = "",
y = "",
size = "Effect size (|log2 ratio|)") +
gtheme +
theme(
axis.text.x = element_blank(),
axis.title.x = element_blank(),
panel.background = element_rect(fill = "white"),
panel.grid.major = element_line(color = "grey80"),
legend.position = "right",
axis.title = element_text(size = 16),
legend.key = element_rect(fill = "transparent"),
panel.grid.major.y = element_line(color = "grey75"),
strip.background = element_blank(),
strip.text = element_text(size = 16),
legend.text = element_text(size = 16),
legend.title = element_text(size = 16),
axis.text.y = element_text(size = 16),
strip.placement = "outside")
ggsave("C:/Resources/Campus Work/PhD/DATA/BioSCape/figures/day-to-day_phyto.jpg",
width = 18, height = 14, dpi = 600)
#  margalef mandala --------------------------------------------------------
# --- 1. stratification index (ΔT = surface–bottom temperature difference)
strat_index <- ctd_raw %>%
mutate(day_label = recode(as.character(date), !!!custom_labels)) %>%
filter(!is.na(salinity), !is.na(temperature), !is.na(depth),
!is.na(latitude), !is.na(longitude),
!(site == "WB" & station == 5)) %>%
group_by(day_label) %>%
arrange(depth, .by_group = TRUE) %>%
mutate(
pressure = gsw_p_from_z(z = -depth, lat = latitude),
SA = gsw_SA_from_SP(SP = salinity, p = pressure, longitude = longitude, latitude = latitude),
CT = gsw_CT_from_t(SA = SA, t = temperature, p = pressure),
sigma0 = gsw_sigma0(SA = SA, CT = CT)
) %>%
summarise(
delta_sigma = max(sigma0, na.rm = TRUE) - min(sigma0, na.rm = TRUE),  # density difference (stratification proxy)
mean_sigma  = mean(sigma0, na.rm = TRUE),                             # mean potential density anomaly
.groups = "drop"
)
# --- 2. average nutrient availability (mean surface + mid + deep)
nuts_summary <- nuts_data %>%
mutate(day_label = recode(as.character(date_sampled), !!!custom_labels)) %>%
mutate(site = recode(site,
"AlgoaBay" = "AB",
"Walker Bay" = "WB",
"St Helena Bay" = "SHB"
)) %>%
group_by(day_label) %>%
reframe(
DIN = mean(ave_NOx+ave_NH4, na.rm = TRUE),
mean_NOx = mean(ave_NOx, na.rm = TRUE),
mean_NH4 = mean(ave_NH4, na.rm = TRUE),
mean_PO4 = mean(ave_PO4, na.rm = TRUE),
mean_Si  = mean(ave_Si,  na.rm = TRUE),
dindip = DIN /mean_PO4,
dipsi = mean_PO4 / mean_Si,
dinsi = DIN / mean_Si,
)
# --- 3. phytoplankton functional groups (diatoms vs dinoflagellates vs others)
phyto_func <- phyto_data %>%
mutate(
day_label = recode(as.character(date_sampled), !!!custom_labels),
station = readr::parse_number(station)
) %>%
# filter(!(site == "WB" & station == 5)) %>%
group_by(day_label) %>%
mutate(
ttax = sum(total_cells, na.rm = TRUE),             # total cell count per station/day
rel_abun = total_cells / ttax                      # relative abundance for each taxon
) %>%
ungroup() %>%
group_by(day_label, station, taxon) %>%
summarise(
rel_abun = sum(rel_abun, na.rm = TRUE),            # sum in case taxa repeat
.groups = "drop"
) %>%
pivot_wider(
names_from = taxon,
values_from = rel_abun,
values_fill = 0
)
mandala_data <- strat_index %>%
left_join(nuts_summary, by = c("day_label")) %>%
left_join(phyto_func, by = c("day_label"))
mandala_data_long <- mandala_data %>%
pivot_longer(
cols = 13:ncol(mandala_data),    # adjust to include all genus columns
names_to = "taxon",
values_to = "rel_abun"
) %>%
add_taxonomic_info(lookup_table) %>%
filter(!functional_type %in% c("Zooplankton", "Cyst"))
#try combine on one plot with sec axis
# Find approximate scale ratio between the two nutrient ratios
# Compute scale ratio once
ratio_data <- mandala_data_long %>%
group_by(day_label) %>%
summarise(
ratio_scale = max(dindip, na.rm = TRUE) / max(dinsi, na.rm = TRUE),
.groups = "drop"
)
ggplot(mandala_data_long,
aes(x = delta_sigma, y = dindip)) +
# --- Points (DIN:DIP)
geom_jitter(
aes(size = rel_abun, color = functional_type),
alpha = 0.8, width = 0.45, height = 50
) +
# --- Labels
geom_text_repel(
data = mandala_data_long %>%
distinct(day_label, station, .keep_all = TRUE),
aes(label = interaction(day_label, station)),
size = 5, fontface = "bold", color = "black"
) +
# --- Secondary axis (scaled locally)
scale_y_continuous(
name = "DIN : DIP",
sec.axis = sec_axis(
~ . / mean(ratio_data$ratio_scale, na.rm = TRUE),  # average scale used for axis ticks
name = "DIN : Si"
)
) +
# facet_wrap(~site) +
scale_size(range = c(1, 10), name = "Relative abundance") +
scale_color_brewer(palette = "Dark2", name = "Functional type") +
labs(
x = expression(paste("Potential Density Anomaly (", sigma[theta], " kg m"^-3, ")")),
title = "Phytoplankton succession"
) +
theme_bw() +
theme(
plot.title = element_text(face = "bold", hjust = 0.5),
axis.title.y.left  = element_text(color = "grey10", face = "bold"),
axis.title.y.right = element_text(color = "grey30", face = "bold"),
legend.position = "bottom"
)
mandala_summary <- mandala_data_long %>%
group_by(day_label, delta_sigma, dindip, dinsi, functional_type) %>%
summarise(rel_abun = sum(rel_abun, na.rm = TRUE), .groups = "drop")
mandala_scaled <- mandala_summary %>%
left_join(ratio_data, by = c("day_label")) %>%
mutate(dinsi_scaled = dinsi * ratio_scale)
ggplot(mandala_scaled,
aes(x = delta_sigma, y = dindip)) +
geom_point(
aes(size = rel_abun, fill = functional_type),
shape = 21, color = "black",
alpha = 0.9,
position = position_jitterdodge(jitter.width  = 0.1, jitter.height = 0.4,dodge.width = 0.4)
) +
geom_text_repel(
data = mandala_scaled %>%
distinct(day_label, .keep_all = TRUE),
aes(label = interaction(day_label)),
size = 5, fontface = "bold"
) +
scale_fill_brewer(palette = "Dark2", name = "") +
scale_size(range = c(2, 10), name = "Relative abundance") +
scale_y_continuous(
name = "DIN : DIP",
sec.axis = sec_axis(~ . / mean(ratio_data$ratio_scale, na.rm = TRUE),
name = "DIN : Si")
) +
labs(
x = expression(paste("Potential Density Anomaly (", sigma[theta], " kg m"^-3, ")")),
title = "", fill = ""
) +
gtheme +
theme(
strip.text = element_text(size = 16, face = "bold"),
axis.text = element_text(size = 16, color = "black"),
axis.title = element_text(size = 16),
legend.text = element_text(size = 16),
legend.title = element_text(size = 16),
plot.title = element_text(face = "bold", hjust = 0.5),
legend.position = "bottom",
legend.key.size = unit(0.2,"cm")
) +
guides(
fill = guide_legend(override.aes = list(size = 8))
)
ggsave("C:/Resources/Campus Work/PhD/DATA/BioSCape/figures/margalef.jpg",
width = 18, height = 14, dpi = 300)
